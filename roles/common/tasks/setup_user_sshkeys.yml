---
  - set_fact: ssh_url="{{ readonly_ssh_url }}"
    when: project == "re" and build_user == "nobody"

  - set_fact: base_ssh_url="{{ ssh_url | basename }}"
  - set_fact: base_ssh_dir="{{ base_ssh_url.split('.')[0] }}"

  - name: setup_user | ssh keys - Download
    sudo: yes
    sudo_user: "{{ build_user }}"
    when: project != 'dev'
    get_url: url={{ ssh_url }} dest={{build_user_home}}/{{ base_ssh_url }} force=yes timeout=120
             url_password={{ url_download_key }} url_username=releng

  - name: setup_user | ssh keys - Download
    sudo: yes
    sudo_user: "{{ build_user }}"
    when: project == 'dev'
    copy: src={{ ssh_url }} dest={{build_user_home}}/{{ base_ssh_url }} owner={{ build_user }}  group={{ build_group }} mode=0644

  - name: setup_user | ssh keys - untar
    sudo: yes
    sudo_user: "{{ build_user }}"
    unarchive: copy=no src={{build_user_home}}/{{ base_ssh_url }} dest={{build_user_home}}/

  - name: setup_user | delete ssh keys tarball
    sudo: yes
    sudo_user: "{{ build_user }}"
    file: path={{build_user_home}}/{{ base_ssh_url }} state=absent

  - name: setup_user | create ssh directory
    sudo: yes
    sudo_user: "{{ build_user }}"
    file: path={{build_user_home}}/.ssh state=directory mode=700

  - name: setup_user | ssh keys - id_rsa
    sudo: yes
    sudo_user: "{{ build_user }}"
    command: cp {{build_user_home}}/{{ base_ssh_dir }}/id_rsa {{build_user_home}}/.ssh/id_rsa
    ignore_errors: yes

  - name: setup_user | ssh keys - id_rsa.pub
    sudo: yes
    sudo_user: "{{ build_user }}"
    command: cp {{build_user_home}}/{{ base_ssh_dir }}/id_rsa.pub {{build_user_home}}/.ssh/id_rsa.pub
    ignore_errors: yes

  - name: setup_user | ssh keys - id_dsa
    sudo: yes
    sudo_user: "{{ build_user }}"
    command: cp {{build_user_home}}/{{ base_ssh_dir }}/id_dsa {{build_user_home}}/.ssh/id_dsa
    ignore_errors: yes

  - name: setup_user | ssh keys - id_dsa.pub
    sudo: yes
    sudo_user: "{{ build_user }}"
    command: cp {{build_user_home}}/{{ base_ssh_dir }}/id_dsa.pub {{build_user_home}}/.ssh/id_dsa.pub
    ignore_errors: yes

  - name: setup_user | ssh keys - authorized_keys
    sudo: yes
    sudo_user: "{{ build_user }}"
    ignore_errors: yes
    command: cp {{build_user_home}}/{{ base_ssh_dir }}/authorized_keys {{build_user_home}}/.ssh/authorized_keys
             removes={{build_user_home}}/{{ base_ssh_dir }}/

  - name: setup_user | ssh keys - config
    sudo: yes
    sudo_user: "{{ build_user }}"
    ignore_errors: yes
    command: cp {{build_user_home}}/{{ base_ssh_dir }}/config {{build_user_home}}/.ssh/config
             removes={{build_user_home}}/{{ base_ssh_dir }}/

  - name: setup_user | ssh keys - file attributes for authorized keys
    sudo: yes
    sudo_user: "{{ build_user }}"
    ignore_errors: yes
    file: path={{build_user_home}}/.ssh/{{item.name}} mode={{item.attr}} state=file
    with_items:
     - {name: id_rsa, attr: 600}
     - {name: id_rsa.pub,  attr: 644}
     - {name: id_dsa, attr: 600}
     - {name: id_dsa.pub,  attr: 644}
     - {name: config,  attr: 644}
     - {name: authorized_keys, attr: 600}

  - name: setup_user | root | autorized_keys
    sudo: yes
    sudo_user: root
    file: path=/root/.ssh state=directory

  - name: setup_user | root | autorized_keys
    sudo: yes
    sudo_user: root
    copy: src="authorized_keys" dest="/root/.ssh/authorized_keys" force=yes
    when: ansible_virtualization_type == "docker"

  - name: setup_user | add lines at EOF /etc/ssh/sshd_config
    sudo: yes
    sudo_user: root
    lineinfile: dest="/etc/ssh/sshd_config" line="{{item}}" insertafter=EOF
    with_items:
     - "PasswordAuthentication no"
     - "PermitRootLogin without-password"
     - "PubkeyAuthentication yes"
    when: ansible_virtualization_type == "docker"

  - name: setup_user | disable PermitRootLogin
    sudo: yes
    sudo_user: root
    lineinfile: dest="/etc/ssh/sshd_config" regexp="PermitRootLogin yes" line="#PermitRootLogin yes"
    when: ansible_virtualization_type == "docker"
